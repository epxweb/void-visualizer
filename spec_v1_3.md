# プロジェクト仕様書: Real-time Audio Visualizer "Void"

## v1.3 追加機能要件

### 1. システム改善

#### SYS-01: バックグラウンド描画対応
- **概要**: OBSでのキャプチャなど、他のアプリケーションがアクティブな状態でもビジュアライザーの描画が停止しないように、バックグラウンドでの動作に対応する。
- **背景**: 現在の実装では、ブラウザの省電力機能により、ウィンドウが非アクティブになると`requestAnimationFrame`の呼び出しレートが極端に低下し、アニメーションが停止してしまう。公開アプリケーションとして、ユーザーにブラウザの実験的機能の変更を強いることなく、この問題を解決する必要がある。
- **仕様**:
    - **Page Visibility APIの活用**: ユーザーがアプリケーションのタブを閲覧しているか、他のタブやアプリに切り替えているかを検知するために`Page Visibility API`を導入する。
    - **ハイブリッド描画ループの実装**:
        - **ページがアクティブな場合**: 従来通り`requestAnimationFrame`を利用し、モニターのリフレッシュレートに同期した最も高品質で効率的な描画を行う。
        - **ページが非アクティブな場合**: `requestAnimationFrame`のループを停止し、代わりに**Web Worker**を起動する。Web Workerはバックグラウンドでも制限を受けにくい`setInterval`を使い、約60fpsに相当する間隔でメインスレッドに描画命令を送信し続ける。
    - **シームレスな切り替え**: ユーザーがタブを切り替えた際に、2つの描画方式が自動的かつシームレスに切り替わるように実装する。これにより、ユーザーはページの表示状態を意識することなく、常に滑らかなアニメーションを得ることができる。
- **実装計画**:
    - **`main.js`の更新**:
        - Page Visibility APIのイベントリスナーを追加し、ページの表示状態を管理するロジックを実装する。
        - Web Worker (`worker.js`) を初期化し、メッセージの送受信を行う処理を追加する。
        - アプリケーションのメインループ (`animate`関数周辺) を改修し、ページの表示状態に応じて`requestAnimationFrame`とWeb Workerからの描画トリガーを切り替える構造に変更する。
    - **`worker.js`の新規作成**:
        - メインスレッドから独立して動作するタイマー用のスクリプトを新規に作成する。
        - 内部では`setInterval`を約16.7ミリ秒間隔で実行し、メインスレッドに`postMessage`で定期的にメッセージを送信する処理のみを記述する。
- **留意点**:
    - バックグラウンド動作時は、ユーザーが意図しないCPU負荷やバッテリー消費を避けるため、パフォーマンスへの影響を最小限に留める設計を心がけること。
