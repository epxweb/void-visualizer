# プロジェクト仕様書: Real-time Audio Visualizer "Void"

## v1.3 追加機能要件

### 1. システム改善

#### SYS-01: バックグラウンド描画対応
- **概要**: OBSでのキャプチャなど、他のアプリケーションがアクティブな状態でもビジュアライザーの描画が停止しないように、バックグラウンドでの動作に対応する。
- **背景**: 現在の実装では、ブラウザの省電力機能により、ウィンドウが非アクティブになると`requestAnimationFrame`の呼び出しレートが極端に低下し、アニメーションが停止してしまう。公開アプリケーションとして、ユーザーにブラウザの実験的機能の変更を強いることなく、この問題を解決する必要がある。
- **仕様**:
    - **Page Visibility APIの活用**: ユーザーがアプリケーションのタブを閲覧しているか、他のタブやアプリに切り替えているかを検知するために`Page Visibility API`を導入する。
    - **ハイブリッド描画ループの実装**:
        - **ページがアクティブな場合**: 従来通り`requestAnimationFrame`を利用し、モニターのリフレッシュレートに同期した最も高品質で効率的な描画を行う。
        - **ページが非アクティブな場合**: `requestAnimationFrame`のループを停止し、代わりに**Web Worker**を起動する。Web Workerはバックグラウンドでも制限を受けにくい`setInterval`を使い、**ユーザーが設定したフレームレート（FPS）に応じた間隔**でメインスレッドに描画命令を送信し続ける。
    - **バックグラウンドFPS調整機能**:
        - ユーザーがコントロールパネルを通じて、バックグラウンド描画時のターゲットFPS（例: 15, 30, 60fps）を選択できる機能を提供する。
        - これにより、ユーザーは自身のPC環境や用途（高品質なキャプチャ、低負荷でのBGM利用など）に応じて、描画品質とCPU負荷のバランスを調整できる。
    - **シームレスな切り替え**: ユーザーがタブを切り替えた際に、2つの描画方式が自動的かつシームレスに切り替わるように実装する。これにより、ユーザーはページの表示状態を意識することなく、常に滑らかなアニメーションを得ることができる。
- **実装計画**:
    - **`main.js`の更新**:
        - Page Visibility APIのイベントリスナーを追加し、ページの表示状態を管理するロジックを実装する。
        - Web Worker (`worker.js`) を初期化し、メッセージの送受信を行う処理を追加する。
        - アプリケーションのメインループ (`animate`関数周辺) を改修し、ページの表示状態に応じて`requestAnimationFrame`とWeb Workerからの描画トリガーを切り替える構造に変更する。
        - **UI（コントロールパネル）に、バックグラウンドFPSを調整するための設定項目を追加する。**
        - **UIでFPS設定が変更された際に、Web Workerへ新しい設定値をメッセージで送信する処理を追加する。**
    - **`worker.js`の新規作成**:
        - メインスレッドから独立して動作するタイマー用のスクリプトを新規に作成する。
        - **メインスレッドから目標FPSの値を受け取り、その値に基づいて`setInterval`の実行間隔を動的に変更するロジックを実装する。** 実行間隔が変更されるまでの間は、デフォルトのFPS（例: 60fps）で動作する。
- **留意点**:
    - バックグラウンド動作時は、ユーザーが意図しないCPU負荷やバッテリー消費を避けるため、パフォーマンスへの影響を最小限に留める設計を心がけること。**今回追加するFPS調整機能は、この懸念に対する直接的な解決策となる。**