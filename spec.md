# プロジェクト仕様書: Real-time Audio Visualizer "Void"

## 1. 概要

本プロジェクトは、リアルタイム音声入力に反応するVJ（ビジュアルジョッキー）用ビジュアライザーをWebアプリケーションとして開発するものである。DJプレイ中にOBSのソースとして利用されることを主な用途とし、ミニマルでクールな映像表現を目指す。

- **プロジェクト名**: Void Visualizer
- **バージョン**: 1.0.0
- **ターゲットプラットフォーム**: モダンなデスクトップWebブラウザ (Google Chrome, Firefox, Safari)

---

## 2. デザインコンセプト

- **全体的な方向性**: ミニマル、テクノ、抽象的。
- **カラースキーム**: 基本は**白黒のグレースケール**。ユーザーが色相や明るさを調整できる機能も提供する。
- **テクスチャ**: 全体的に**グレイン（粒状のノイズ）**やテクスチャ感を表現し、デジタルながらも有機的な質感を持たせる。フラットデザインの中にも深みを加える。

---

## 3. 機能要件 (Functional Requirements)

### FR-01: 音声入力と解析

- **FR-01a: 入力ソース**: ブラウザを通じてマイク、またはOSで指定されたオーディオ入力デバイスからのリアルタイム音声を取得できること。
- **FR-01b: 周波数帯域分割**: 音声データを**低域 (Low)・中音域 (Mid)・高域 (High)** の3つの帯域に分割して、それぞれのエネルギー量（音量）を個別に数値化できること。
- **FR-01c: 感度閾値設定**: 各周波数帯域に対して、ビジュアルが反応を開始する**閾値**をユーザーが設定できること。
- **FR-01d: ビート検出**: 低域または指定された周波数帯域の急激なエネルギー上昇を検知し、ビートとしてイベントを発火できること。（※簡易的なビート検出を実装済み）

### FR-02: ビジュアル描画エンジン

- **FR-02a: 基本要素**: 描画はシンプルな**二次元の図形、線、パーティクル**の組み合わせで構成されること。
- **FR-02b: 音声反応**: FR-01で解析した各帯域のエネルギー量やビート検出イベントに応じて、図形の大きさ、数、色、位置、動きなどがリアルタイムに変化すること。
- **FR-02c: グレインエフェクト**: 画面全体に適用されるグレイン（ノイズ）の強さを調整できること。ポストプロセッシングシェーダーにより実装済み。

### FR-03: ユーザーインターフェース (UI)

- **FR-03a: コントロールパネル**: 以下のパラメータを調整するためのスライダーやボタンを画面上に表示できること。パネルはキーボードの `h` キーで表示・非表示を切り替え可能とする。
  - 低域 / 中音域 / 高域の感度閾値
  - シーンスロットの割り当て
  - 全体の色相 (Hue) ※v1.0では未実装
  - 全体の明るさ (Brightness) ※v1.0では未実装
  - グレインの強さ
  - 背景色 / 前景色
- **FR-03b: 全画面表示**: ボタン一つでブラウザの全画面表示モードに切り替えられること。

### FR-04: シーン管理

- **FR-04a: シーンのモジュール化**: 各ビジュアルパターンは独立した「シーン」モジュールとして定義されること。詳細は「7. 実装済みビジュアルシーン」を参照。
- **FR-04b: シーンスロット**: パフォーマンス用に最大5つの「スロット」が用意されること。ユーザーはUIを通じて、利用可能なシーンの中から好きなものを各スロットに割り当てることができる。
- **FR-04c: 手動切り替え**: キーボードの数字キー（`1`～`5`）で対応するスロットのシーンに即時切り替え、`h`キーでコントロールパネルの表示/非表示を切り替えが可能であること。
- **FR-04d: 自動遷移**: 設定された時間が経過すると、現在のスロットから次のスロットのシーンへ**なめらかに（クロスフェードで）自動遷移**すること。

---

## 4. 非機能要件 (Non-Functional Requirements)

- **NFR-01: パフォーマンス**: 常に**60fps**での描画を目標とし、スムーズなアニメーションを維持すること。
- **NFR-02: 互換性**: 主要なモダンブラウザの最新版で問題なく動作すること。
- **NFR-03: 運用性**: OBSの「ブラウザソース」機能で簡単に取り込めるよう、シンプルなURL構造と透過背景に対応済み。

---

## 5. 技術スタック

- **フロントエンド**: HTML5, CSS3, JavaScript (ES Modules)
- **音声処理**: **Web Audio API** (ブラウザ標準)
- **描画ライブラリ**: **Three.js (WebGL)**
  - *プロトタイピング段階ではp5.jsを使用したが、高パフォーマンスと高度な表現のためThree.jsに移行済み。*
- **UIコントロール**: **Tweakpane**
- **開発環境**: Visual Studio Code + Gemini CLI

---

## 6. 開発マイルストーン - **完了**

1.  **M1: コア機能PoC (Proof of Concept)** - **完了**
    - [x] Web Audio APIでマイク入力を取得。
    - [x] 全体の音量を取得し、p5.jsで円の大きさを変化させる。
2.  **M2: 音声解析エンジンの実装** - **完了**
    - [x] 音声を低・中・高の3帯域に分割。
    - [x] 各帯域の音量に応じて、異なる図形パラメータを制御する。
    - [x] シンプルなビート検出アルゴリズムを実装する。
3.  **M3: ビジュアルシーンの開発** - **完了**
    - [x] ミニマルなデザインのビジュアルシーンを最低3種類作成する。
    - [x] WebGL (Three.js) を導入し、パーティクル表現とグレインエフェクト（シェーダー）を実装する。
4.  **M4: UIとコントロールの実装** - **完了**
    - [x] Tweakpaneを導入し、機能要件で定義されたパラメータを操作できるようにする。
    - [x] Tweakpane上にシーンスロット選択UIを実装する。
    - [x] 全画面表示機能を実装する。
5.  **M5: シーン管理と仕上げ** - **完了**
    - [x] シーンの自動遷移とクロスフェード機能を実装する。
    - [x] OBSでの利用を想定した最終的なパフォーマンスチューニングとデバッグを行う。
      - [x] 背景透過の有効化
      - [x] UI表示/非表示機能の追加
      - [x] シーン管理方法をリファクタリングし、リソース解放処理を実装

---

## 7. 実装済みビジュアルシーン

現在、以下のシーンが実装されている。

### シーン: Wavy Lines
- **概要**: 画面を横切る複数の波打つ線で構成される。
- **低域 (Bass)**: 線の数に影響する。
- **中域 (Mid)**: 線の波の大きさに影響する。
- **高域 (Treble)**: 線のノイズ感・グリッチ感に影響する。

### シーン: Pulsing Polygon
- **概要**: 画面中央で脈動・回転する多角形で構成される。
- **低域 (Bass)**: 多角形の大きさ（脈動）に影響する。
- **中域 (Mid)**: 多角形の回転速度に影響する。
- **高域 (Treble)**: 多角形の頂点の歪み（トゲの鋭さ）に影響する。

#### シーン: Infinite Tunnel
- **概要**: 画面奥に向かって無限に続くワイヤーフレームのトンネル。音楽の疾走感を表現する。
- **低域 (Bass)**: ビートに合わせてトンネルの半径が一瞬拡大する。
- **中域 (Mid)**: トンネルを突き進むスピードが変化する。
- **高域 (Treble)**: ワイヤーフレームに歪みやグリッチ（ねじれ）を加える。

#### シーン: Rotating Rings
- **概要**: レコード盤をイメージした、複数の同心円がそれぞれ回転する。
- **低域 (Bass)**: 円の線の太さが脈動するように変化する。
- **中域 (Mid)**: 各円の回転速度や回転方向が変化する。
- **高域 (Treble)**: 円周上にノイズやギザギザした乱れを加える。

#### シーン: Warping Grid
- **概要**: 画面全体に広がるグリッド（格子）が、回転しながら拡大・縮小を繰り返す。
- **低域 (Bass)**: ビートに合わせてグリッド全体が拡大・縮小する。
- **中域 (Mid)**: グリッドの回転速度が変化する。
- **高域 (Treble)**: 格子の交点がランダムに明滅する。

---

## 8. 開発プロセスに関する注記

- **コードの完全性**: Geminiによるmain.jsのコード更新・ファイル書き込みの際、`replace`または`write_file`ツールの`new_string`や`content`引数に渡すコードは、**いかなる場合も省略してはならない**。一部の関数を`/* ... */`のように省略すると、スクリプト全体が動作しなくなる原因となる。常に完全なコードスニペットを提供し、リグレッション（機能低下）の発生を防ぐこと。
