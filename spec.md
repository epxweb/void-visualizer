# プロジェクト仕様書: Real-time Audio Visualizer "Void"

## 1. 概要

本プロジェクトは、リアルタイム音声入力に反応するVJ（ビジュアルジョッキー）用ビジュアライザーをWebアプリケーションとして開発するものである。DJプレイ中にOBSのソースとして利用されることを主な用途とし、ミニマルでクールな映像表現を目指す。

- **プロジェクト名**: Void Visualizer
- **バージョン**: 1.3.0
- **ターゲットプラットフォーム**: モダンなデスクトップWebブラウザ (Google Chrome, Firefox, Safari)

---

## 2. デザインコンセプト

- **全体的な方向性**: ミニマル、テクノ、抽象的。
- **カラースキーム**: 基本は**白黒のグレースケール**。ユーザーが色相や明るさを調整できる機能も提供する。
- **テクスチャ**: 全体的に**グレイン（粒状のノイズ）**やテクスチャ感を表現し、デジタルながらも有機的な質感を持たせる。フラットデザインの中にも深みを加える。

---

## 3. 機能要件 (Functional Requirements)

### FR-01: 音声入力と解析

- **FR-01a: 入力ソース**: ブラウザを通じてマイク、またはOSで指定されたオーディオ入力デバイスからのリアルタイム音声を取得できること。
- **FR-01b: 周波数帯域分割**: 音声データを**低域 (Low)・中音域 (Mid)・高域 (High)** の3つの帯域に分割して、それぞれのエネルギー量（音量）を個別に数値化できること。
- **FR-01c: 感度閾値設定**: 各周波数帯域に対して、ビジュアルが反応を開始する**閾値**をユーザーが設定できること。
- **FR-01d: ビート検出**: 低域または指定された周波数帯域の急激なエネルギー上昇を検知し、ビートとしてイベントを発火できること。（※簡易的なビート検出を実装済み）

### FR-02: ビジュアル描画エンジン

- **FR-02a: 基本要素**: 描画はシンプルな**二次元の図形、線、パーティクル**の組み合わせで構成されること。
- **FR-02b: 音声反応**: FR-01で解析した各帯域のエネルギー量やビート検出イベントに応じて、図形の大きさ、数、色、位置、動きなどがリアルタイムに変化すること。
- **FR-02c: グレインエフェクト**: 画面全体に適用されるグレイン（ノイズ）の強さを調整できること。ポストプロセッシングシェーダーにより実装済み。
- **FR-02d: ストロボエフェクト**: 低域 (Bass) のエネルギー量に応じて、画面全体を瞬間的に白くフラッシュさせるエフェクト。ポストプロセッシングシェーダーにより実装。

### FR-03: ユーザーインターフェース (UI)

- **FR-03a: コントロールパネル**: 以下のパラメータを調整するためのスライダーやボタンを画面上に表示できること。パネルはキーボードの `h` キーで表示・非表示を切り替え可能とする。
  - 低域 / 中音域 / 高域の感度閾値
  - シーンスロットの割り当て（「Empty」を含む）
  - グレインの強さ
  - 背景色 / 前景色
  - ストロボのON/OFF、感度、明るさ
  - シーン自動遷移のON/OFF、間隔、継続時間
  - シーン自動遷移のランダム化ON/OFF
  - バックグラウンド描画時のFPS (Background FPS)
- **FR-03b: 全画面表示**: ボタン一つでブラウザの全画面表示モードに切り替えられること。

### FR-04: シーン管理

- **FR-04a: シーンのモジュール化**: 各ビジュアルパターンは独立した「シーン」モジュールとして定義されること。詳細は「7. 実装済みビジュアルシーン」を参照。
- **FR-04b: シーンスロット**: パフォーマンス用に最大5つの「スロット」が用意されること。ユーザーはUIを通じて、利用可能なシーンの中から好きなものを各スロットに割り当てることができる。
- **FR-04c: 手動切り替え**: キーボードの数字キー（`1`～`5`）で対応するスロットのシーンに即時切り替え、`h`キーでコントロールパネルの表示/非表示を切り替えが可能であること。
- **FR-04d: 自動遷移**: 設定された時間が経過すると、現在のスロットから次のスロットのシーンへ**なめらかに（クロスフェードで）自動遷移**する。遷移の順序は、スロット番号順の**シーケンシャル**と、**ランダム**から選択できる。
- **FR-04e: Emptyスロット**: 5つのシーンスロットに、何も表示しない「Empty」状態を割り当てることができる。Emptyスロットは自動遷移の対象から除外される。

---

## 4. 非機能要件 (Non-Functional Requirements)

- **NFR-01: パフォーマンス**: 常に**60fps**での描画を目標とし、スムーズなアニメーションを維持すること。
- **NFR-02: 互換性**: 主要なモダンブラウザの最新版で問題なく動作すること。
- **NFR-03: 運用性**: OBSの「ブラウザソース」機能で簡単に取り込めるよう、シンプルなURL構造と透過背景に対応。**タブが非アクティブな状態でも描画が継続するため、安定したキャプチャが可能。**

---

## 5. 技術スタック

- **フロントエンド**: HTML5, CSS3, JavaScript (ES Modules)
- **音声処理**: **Web Audio API** (ブラウザ標準)
- **描画ライブラリ**: **Three.js (WebGL)**
- **UIコントロール**: **Tweakpane**
- **開発環境**: Visual Studio Code + Gemini CLI

---

## 6. 開発マイルストーン

1.  **M1: コア機能PoC (Proof of Concept)** - **完了**
2.  **M2: 音声解析エンジンの実装** - **完了**
3.  **M3: ビジュアルシーンの開発** - **完了**
4.  **M4: UIとコントロールの実装** - **完了**
5.  **M5: シーン管理と仕上げ (v1.0.0)** - **完了**
6.  **M6: v1.1 機能追加** - **完了**
    - [x] ストロボ機能の実装。
    - [x] シーン自動遷移のランダム化オプションを追加。
    - [x] Emptyスロット機能を実装。
6.  **M7: v1.2 機能追加** - **完了**
    - [x] 追加3シーン実装。
6.  **M8: v1.3 機能追加** - **完了**
    - [x] バックグラウンド再生機能の実装。

---

## 7. 実装済みビジュアルシーン

現在、以下のシーンが実装されている。

### シーン: Wavy Lines
- **概要**: 画面を横切る複数の波打つ線で構成される。
- **低域 (Bass)**: 線の数に影響する。
- **中域 (Mid)**: 線の波の大きさに影響する。
- **高域 (Treble)**: 線のノイズ感・グリッチ感に影響する。

### シーン: Pulsing Polygon
- **概要**: 画面中央で脈動・回転する多角形で構成される。
- **低域 (Bass)**: 多角形の大きさ（脈動）に影響する。
- **中域 (Mid)**: 多角形の回転速度に影響する。
- **高域 (Treble)**: 多角形の頂点の歪み（トゲの鋭さ）に影響する。

#### シーン: Infinite Tunnel
- **概要**: 画面奥に向かって無限に続くワイヤーフレームのトンネル。音楽の疾走感を表現する。
- **低域 (Bass)**: ビートに合わせてトンネルの半径が一瞬拡大する。
- **中域 (Mid)**: トンネルを突き進むスピードが変化する。
- **高域 (Treble)**: ワイヤーフレームに歪みやグリッチ（ねじれ）を加える。

#### シーン: Rotating Rings
- **概要**: ステレオスピーカーをイメージした、複数の同心円がそれぞれ振動する。
- **低域 (Bass)**: 円の線の太さが脈動するように変化する。
- **中域 (Mid)**: 各円の回転速度や回転方向が変化する。
- **高域 (Treble)**: 円周上にノイズやギザギザした乱れを加える。

#### シーン: Wireframe Mirrorball
- **概要**: 画面中央に配置されたワイヤーフレームのミラーボールから、放射状に無数の直線が放たれる。クラシックなモチーフをミニマルに再解釈したビジュアル。
- **低域 (Bass)**: 放射される直線が一斉に長く、そして明るくなる。
- **中域 (Mid)**: ミラーボール本体の回転速度が変化する。
- **高域 (Treble)**: 放射される直線の本数や角度がランダムに変化する。

#### シーン: Warping Grid
- **概要**: 画面全体に広がるグリッド（格子）が、回転しながら拡大・縮小を繰り返す。
- **低域 (Bass)**: ビートに合わせてグリッド全体が拡大・縮小する。
- **中域 (Mid)**: グリッドの回転速度が変化する。
- **高域 (Treble)**: 格子の交点がランダムに明滅する。

#### シーン: Pulsing 3D Grid
- **概要**: 立方体の3Dグリッド上にプロットされた多数の円形の点が、ビートに合わせてリズミカルに脈動する。`WarpingGrid`シーンの3次元的な発展形。
- **低域 (Bass)**: 全ての点のサイズが一斉に拡大・縮小し、力強い脈動感を表現する。
- **中域 (Mid)**: グリッド全体がZ軸周りをゆっくりと回転する。
- **高域 (Treble)**: 各点の色や不透明度がランダムに明滅し、きらびやかな印象を与える。

#### シーン: Curve Racer
- **概要**: 画面内に描かれた閉じた8の字コースの線上を、光る円が滑らかに滑走する。音楽のテンポと円の速度がシンクロすることで、高い没入感を生み出す。
- **低域 (Bass)**: 滑走する円のサイズや輝度が変化する。
- **中域 (Mid)**: 円がコースを滑走する速度が変化する。
- **高域 (Treble)**: コース自体の形状が、ノイズによって細かく歪む。

---

## 8. 開発プロセスに関する注記

- **コードの完全性**: Geminiによるmain.jsのコード更新・ファイル書き込みの際、`replace`または`write_file`ツールの`new_string`や`content`引数に渡すコードは、**いかなる場合も省略してはならない**。一部の関数を`/* ... */`のように省略すると、スクリプト全体が動作しなくなる原因となる。常に完全なコードスニペットを提供し、リグレッション（機能低下）の発生を防ぐこと。

---

## 9. 変更履歴

### v1.3.0 (2025-09-05)
- **機能追加**
  - バックグラウンド描画機能を追加。タブが非アクティブでもアニメーションが停止しないように対応。
  - バックグラウンド描画時のFPSを調整する機能（15/30/60fps）をコントロールパネルに追加。
- **UI改善**
  - `Strobe Sensitivity` パラメータの動作を他の感度設定と統一し、スライダーを上げるとより敏感に反応するように修正。

### v1.2.0 (2025-09-04)
- **機能追加**
  - 新規シーンを3点追加。
- **シーン改修**
  - Rotating Ringsのデザインを調整。

### v1.1.0 (2025-09-04)
- **機能追加**
  - ビートに連動するストロボエフェクト機能を追加。
  - シーンの自動遷移にランダム順序オプションを追加。
  - シーンスロットに何も表示しない「Empty」状態を割り当てられる機能を追加。
- **UI改善**
  - 上記機能追加に伴い、コントロールパネルに各種設定項目（ストロボON/OFF・感度・明るさ、ランダム遷移ON/OFF）を追加。
  - シーン選択ドロップダウンに「Empty」を追加。

### v1.0.0
- 初期リリース
