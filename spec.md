# プロジェクト仕様書: Real-time Audio Visualizer "Void"

## 1. 概要

本プロジェクトは、リアルタイム音声入力に反応するVJ（ビジュアルジョッキー）用ビジュアライザーをWebアプリケーションとして開発するものである。DJプレイ中にOBSのソースとして利用されることを主な用途とし、ミニマルでクールな映像表現を目指す。

- **プロジェクト名**: Void Visualizer
- **バージョン**: 1.3.0
- **ターゲットプラットフォーム**: モダンなデスクトップWebブラウザ (Google Chrome, Firefox, Safari)

---

## 2. デザインコンセプト

- **全体的な方向性**: ミニマル、テクノ、抽象的。
- **カラースキーム**: 基本は**白黒のグレースケール**。ユーザーが色相や明るさを調整できる機能も提供する。
- **テクスチャ**: 全体的に**グレイン（粒状のノイズ）**やテクスチャ感を表現し、デジタルながらも有機的な質感を持たせる。フラットデザインの中にも深みを加える。

---

## 3. 機能要件 (Functional Requirements)

### FR-01: 音声入力と解析

- **FR-01a: 入力ソース**: ブラウザを通じてマイク、またはOSで指定されたオーディオ入力デバイスからのリアルタイム音声を取得できること。
- **FR-01b: 周波数帯域分割**: 音声データを**低域 (Low)・中音域 (Mid)・高域 (High)** の3つの帯域に分割して、それぞれのエネルギー量（音量）を個別に数値化できること。
- **FR-01c: 感度閾値設定**: 各周波数帯域に対して、ビジュアルが反応を開始する**閾値**をユーザーが設定できること。
- **FR-01d: ビート検出**: 低域または指定された周波数帯域の急激なエネルギー上昇を検知し、ビートとしてイベントを発火できること。（※簡易的なビート検出を実装済み）

### FR-02: ビジュアル描画エンジン

- **FR-02a: 基本要素**: 描画はシンプルな**二次元の図形、線、パーティクル**の組み合わせで構成されること。
- **FR-02b: 音声反応**: FR-01で解析した各帯域のエネルギー量やビート検出イベントに応じて、図形の大きさ、数、色、位置、動きなどがリアルタイムに変化すること。
- **FR-02c: グレインエフェクト**: 画面全体に適用されるグレイン（ノイズ）の強さを調整できること。ポストプロセッシングシェーダーにより実装済み。
- **FR-02d: ストロボエフェクト**: 低域 (Bass) のエネルギー量に応じて、画面全体を瞬間的に白くフラッシュさせるエフェクト。ポストプロセッシングシェーダーにより実装。

### FR-03: ユーザーインターフェース (UI)

- **FR-03a: コントロールパネル**: 以下のパラメータを調整するためのスライダーやボタンを画面上に表示できること。パネルはキーボードの `h` キーで表示・非表示を切り替え可能とする。
  - 低域 / 中音域 / 高域の感度閾値
  - シーンスロットの割り当て（「Empty」を含む）
  - グレインの強さ
  - 背景色 / 前景色
  - ストロボのON/OFF、感度、明るさ
  - シーン自動遷移のON/OFF、間隔、継続時間
  - シーン自動遷移のランダム化ON/OFF
  - バックグラウンド描画時のFPS (Background FPS)
- **FR-03b: 全画面表示**: ボタン一つでブラウザの全画面表示モードに切り替えられること。

### FR-04: シーン管理

- **FR-04a: シーンのモジュール化**: 各ビジュアルパターンは独立した「シーン」モジュールとして定義されること。詳細は「7. 実装済みビジュアルシーン」を参照。
- **FR-04b: シーンスロット**: パフォーマンス用に最大5つの「スロット」が用意されること。ユーザーはUIを通じて、利用可能なシーンの中から好きなものを各スロットに割り当てることができる。
- **FR-04c: 手動切り替え**: キーボードの数字キー（`1`～`5`）で対応するスロットのシーンに即時切り替え、`h`キーでコントロールパネルの表示/非表示を切り替えが可能であること。
- **FR-04d: 自動遷移**: 設定された時間が経過すると、現在のスロットから次のスロットのシーンへ**なめらかに（クロスフェードで）自動遷移**する。遷移の順序は、スロット番号順の**シーケンシャル**と、**ランダム**から選択できる。
- **FR-04e: Emptyスロット**: 5つのシーンスロットに、何も表示しない「Empty」状態を割り当てることができる。Emptyスロットは自動遷移の対象から除外される。

---

## 4. 非機能要件 (Non-Functional Requirements)

- **NFR-01: パフォーマンス**: 常に**60fps**での描画を目標とし、スムーズなアニメーションを維持すること。
- **NFR-02: 互換性**: 主要なモダンブラウザの最新版で問題なく動作すること。
- **NFR-03: 運用性**: OBSの「ブラウザソース」機能で簡単に取り込めるよう、シンプルなURL構造と透過背景に対応。**タブが非アクティブな状態でも描画が継続するため、安定したキャプチャが可能。**

---

## 5. 技術スタック

- **フロントエンド**: HTML5, CSS3, JavaScript (ES Modules)
- **音声処理**: **Web Audio API** (ブラウザ標準)
- **描画ライブラリ**: **Three.js (WebGL)**
- **UIコントロール**: **Tweakpane**
- **開発環境**: Visual Studio Code + Gemini CLI

---

## 6. 開発マイルストーン

1.  **M1: コア機能PoC (Proof of Concept)** - **完了**
2.  **M2: 音声解析エンジンの実装** - **完了**
3.  **M3: ビジュアルシーンの開発** - **完了**
4.  **M4: UIとコントロールの実装** - **完了**
5.  **M5: シーン管理と仕上げ (v1.0.0)** - **完了**

---

## 7. 開発プロセスに関する注記

- **コードの完全性**: Geminiによるmain.jsのコード更新・ファイル書き込みの際、`replace`または`write_file`ツールの`new_string`や`content`引数に渡すコードは、**いかなる場合も省略してはならない**。一部の関数を`/* ... */`のように省略すると、スクリプト全体が動作しなくなる原因となる。常に完全なコードスニペットを提供し、リグレッション（機能低下）の発生を防ぐこと。

---

## 8. 変更履歴

### v1.4.0 (2025-09-06)
- **機能追加**
  - スマートフォン操作に対応。ダブルタップでUI非表示/表示、スワイプでシーン遷移。
  - 現在再生中のスロットとシーン名を表示。
- **シーン改修**
  - Tri TileとSolar Systemを新規追加。
  - CurveRacerを一覧から削除。

### v1.3.0 (2025-09-05)
- **機能追加**
  - バックグラウンド描画機能を追加。タブが非アクティブでもアニメーションが停止しないように対応。
  - バックグラウンド描画時のFPSを調整する機能（15/30/60fps）をコントロールパネルに追加。
- **UI改善**
  - `Strobe Sensitivity` パラメータの動作を他の感度設定と統一し、スライダーを上げるとより敏感に反応するように修正。

### v1.2.0 (2025-09-04)
- **機能追加**
  - 新規シーンを3点追加。
- **シーン改修**
  - Rotating Ringsのデザインを調整。

### v1.1.0 (2025-09-04)
- **機能追加**
  - ビートに連動するストロボエフェクト機能を追加。
  - シーンの自動遷移にランダム順序オプションを追加。
  - シーンスロットに何も表示しない「Empty」状態を割り当てられる機能を追加。
- **UI改善**
  - 上記機能追加に伴い、コントロールパネルに各種設定項目（ストロボON/OFF・感度・明るさ、ランダム遷移ON/OFF）を追加。
  - シーン選択ドロップダウンに「Empty」を追加。

### v1.0.0
- 初期リリース
