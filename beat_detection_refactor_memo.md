# ビート検出アルゴリズムの改善に関するメモ

## 1. 目的

従来のビート検出アルゴリズムにおいて、規則的な4つ打ちのビートでも検出漏れが発生する問題を解決し、より正確で安定したビート検出を実現する。

## 2. 従来アルゴリズムの問題点

*   **比較対象が短期的すぎる:** 従来のアルゴリズムは、現在のフレームの音量を「直前1フレームのみの音量」と比較していた。
*   **タイミングのズレに弱い:** `requestAnimationFrame` の実行タイミングのわずかな揺らぎにより、キック音のピークを正確に捉えきれない場合があった。ピーク直後の少し減衰した音量を拾ってしまうと、直前フレームとの音量差が小さくなり、閾値を超えられず検出漏れが発生していた。

## 3. 新アルゴリズムの概要：移動平均の導入

上記の問題を解決するため、比較の基準を「直前の1点」から「最近の平均値」に変更した。

*   **音量履歴の保持:** 過去`BASS_HISTORY_LENGTH`（例: 16フレーム）分の低音域(bass)の音量を常に記録する。
*   **移動平均の計算:** 記録した音量履歴から平均値（移動平均）を算出する。
*   **突出量の検出:** 現在の音量が、この移動平均値に対して`BEAT_DYNAMIC_THRESHOLD`（例: 1.4倍）で設定された係数以上に「突出」した場合にのみ、ビートとして検出する。

```javascript
// 新アルゴリズムの判定部分のイメージ
if (bass > movingAverage * BEAT_DYNAMIC_THRESHOLD && (currentTime - lastBeatTime) > BEAT_COOLDOWN) {
    // ビートとして検出
}
```

## 4. 改善によるメリット

*   **安定性の向上:** フレーム単位のタイミングのズレに影響されにくくなり、安定してビートの急な立ち上がり（アタック）を捉えることができる。
*   **ロバスト性の向上:** 曲全体の音量が上下しても、常に「最近の音量と比較して突出しているか」を見るため、より堅牢な検出が可能になる。

## 5. 調整可能なパラメータ

アルゴリズムの感度は `main.js` 上部の以下の定数で調整可能。

*   `BEAT_COOLDOWN`: ビート検出後のクールダウン時間(ms)。BPMが速い曲で取りこぼす場合はこの値を短くする。
*   `BASS_HISTORY_LENGTH`: 移動平均の計算に使う過去のフレーム数。値を大きくすると安定するが、急なBPMの変化への追従は遅くなる。
*   `BEAT_DYNAMIC_THRESHOLD`: 平均音量の何倍を超えたらビートと判定するかの係数。値を小さくすると感度が上がり、ノイズを拾いやすくなる。
